# 隐私保护
得益于云计算的发展，它以较低的成本提供了可扩展的计算和存储能力，为各类企业、政府以及个人用户提供了便利。他们已经开始将他们的计算任务和存储需求转移至第三方公共云服务提供商，例如微软的Azure、亚马逊的AWS、阿里云等。虽然云计算为企业提供了前所未有的机遇，例如提升服务、扩大收入、与其他合作伙伴进行协作，但它也不可避免地带来了一些严重的副作用，尤其是关于隐私的问题。在向量检索领域，隐私保护的问题同样也很重要。向量检索作为一种常见的数据检索方式，其数据通常包含大量的用户信息和敏感数据。当这些数据被上传到云端进行处理和存储时，如果没有适当的隐私保护措施，就可能会导致这些敏感信息的泄露。尤其在云计算环境中，数据的所有者和处理者往往不是同一方。这就意味着，数据所有者需要将他们的数据委托给云服务提供商进行处理和存储。如果隐私保护方案不够完善，那么存储在云端的用户数据就有可能被泄露。此外，向量检索的特性使得数据在处理过程中可能会被复制和传输，这进一步增加了数据泄露的风险。因此，如何在享受云计算带来的便利和可扩展性的同时，有效地保护向量检索中的数据隐私，已经成为了一些学者的工作重点。

## 现有方案的限制
在近似最近邻检索算法中的隐私保护问题可以表示为如何在不泄漏原始向量、查询或返回结构的情况下执行。近年来，已经有很多工作在隐私保护查询取得了进展，这些加密策略在很难在高维度向量的加密中直接应用主要是因为有以下限制:  
1. 只适用于关系数据库或低维数据集的限制：现有的隐私保护查询方法主要是针对关系数据库或低维数据集设计的。关系数据库是以表格的形式存储数据的数据库，而低维数据集的数据维度通常小于5。然而，对于高维度的数据，这些方法可能不适用。这主要是因为高维数据的复杂性和多样性，使得直接应用这些方法可能会导致效率低下或者无法达到预期的隐私保护效果。
2. 采用完全同态加密可能耗时过长的限制：完全同态加密（FHE）是一种允许在密文上直接进行计算的加密方法，而无需先解密。这样可以保护数据的隐私，但是，FHE的计算效率通常较低，特别是对于复杂的查询例如近似最近邻检索，如果使用FHE，可能会导致查询时间过长，从而影响系统的性能。
3. 使用顺序保持编码（OPE）可能产生过多的通信和时间成本的限制：OPE是一种可以在密文上保持原始数据顺序的加密方法。这使得它可以提高处理查询的效率，因为可以在密文上直接进行比较操作。然而，使用OPE时，为了访问加密的索引和解密密文，可能需要进行多轮的通信，这会增加通信的时间和成本。此外，多轮通信也可能增加数据泄露的风险。

## 基础概念
在介绍加密近似最近邻检索前，让我们先了解一些加密算法的概念。
### 加法同态操作
在密码学中，"同态"这个词描述了一种能够在加密数据上进行计算，并且这些计算的结果与在未加密数据上进行相同计算的结果是一致的，即使数据在计算过程中一直保持加密状态。举个例子，假设我们有一个加法同态加密系统，我们有两个数字2和3，我们先加密这两个数字。在加法同态系统中，我们可以直接对这两个加密的结果进行加法操作，得到一个新的加密结果。然后，当我们解密这个新的加密结果时，我们会得到5，这就是2和3的和。这就是加法同态的主要特性，即使在加密状态下，我们仍然可以进行加法操作，而不需要解密数据。这种特性对于许多应用非常有用，尤其是在需要在加密数据上进行计算的情况下，如云计算和数据隐私保护等。

### Paillier加密
Paillier加密是一种公钥加密系统，由法国密码学家Pascal Paillier在1999年提出。这种加密系统的主要特性是它的同态性质，特别是它支持加法同态操作Paillier加密系统的工作原理是这样的：
1. **密钥生成**：首先，选择两个大的质数$p$和$q$，并计算$n = p \times q$和$\lambda = \text{lcm}(p-1, q-1)$，其中$\text{lcm}$是最小公倍数函数。公钥是$n$，私钥是$(n, \lambda)$。
2. **加密**：给定一个明文$m$和公钥$n$，选择一个随机数$r$，其中$0 < r < n$和 $\gcd(r, n) = 1$，$\gcd$是最大公约数函数。密文$c$是$c = g^m \times r^n \mod n^2$，其中$g$是一个随机选择的数，满足$\gcd(g, n^2) = 1$。
3. **解密**：给定一个密文$c$和私钥$(n, \lambda)$，明文$m$是$m = \frac{L(c^\lambda \mod n^2)}{L(g^\lambda \mod n^2)} \mod n$，其中函数$L(x) = \frac{x-1}{n}$。

Paillier加密的同态性质表现在以下两个方面：

1. **加法同态性**：给定两个明文$m_1$和$m_2$，他们的加密结果的乘积将等于$m_1 + m_2$的加密结果，即$E(m_1) \cdot E(m_2) = E(m_1 + m_2)$。
2. **乘法同态性**：给定一个明文$m$和一个整数$k$，$m$的加密结果的$k$次方将等于$k \cdot m$的加密结果，即$E(m)^k = E(k \cdot m)$。

### AES加密

AES (Advanced Encryption Standard) 是一种对称加密算法，也就是说，它使用相同的密钥进行加密和解密。AES由美国国家标准和技术研究院（NIST）于2001年发布为FIPS PUB 197，并在全球范围内广泛使用。AES是一种基于块的加密算法，通常使用128位的块，但密钥长度可以是128位、192位或256位。

AES的加密过程包括多个轮次，每个轮次都包含几个步骤：字节替换（SubBytes）、行移位（ShiftRows）、列混淆（MixColumns，最后一轮除外）和轮密钥加（AddRoundKey）。每一轮都使用了从原始密钥派生出的不同轮密钥。轮数取决于密钥的长度：10轮用于128位密钥，12轮用于192位密钥，14轮用于256位密钥。解密过程与加密过程相反，使用逆操作以相反的顺序进行。


## SCPQ
安全粗糙乘积量化（SCPQ）是一个为了解决在云上进行近似最近邻检索的方案。SCPQ是一种基于高维隐私保护查询框架的方法，主要结合了加密和乘积量化（PQ）技术。这种方法不仅考虑了数据重构的隐私，还包括数据所有者、数据用户、私有云和pCSP的角色。
作者在论文中举例了一个场景，例如在基于云的电子健康记录（EHRs）系统中，一个医院的医生可能是其框架中的用户。当用户提交查询时，私有云首先将查询转换为相应的代码和索引。然后，pCSP与用户交互，在加密形式下搜索查询，并使用简单的加法同态操作以获取查询和原始向量之间的加密距离。最后，pCSP从代码中维护一个IVF列表，并解密候选距离以返回结果。

### 框架
框架的目标是在云环境中安全地进行高维数据存储和近似最近邻检索。这个框架涉及四个主要参与者：

1. **数据拥有者（DO）**：DO拥有一个在d维空间中的数据库D。由于计算和存储资源有限，DO将数据库和搜索工作负载外包给pCSP。为了数据安全，DO在外包之前会对数据进行加密。为了在搜索过程中保护数据，DO应该为数据构建一个倒排文件（IVF）列表，并将其加密后发送给pCSP。

2. **隐私保护的云服务提供商（pCSP）**：pCSP通常由第三方服务提供商支持。他拥有可扩展的计算和存储设施，可以为高维数据存储和近似kNN查询提供云平台。然而，他对数据和查询感兴趣，可能会非法地解密和搜索DO存储的数据，或者受到外部攻击者的攻击。假设他可以正确地处理近似kNN查询，但不能从加密数据中推断出任何有价值的信息。

3. **用户（US）**：US拥有小型的存储和计算能力，例如移动终端。当发出查询请求时，授权的US可以访问存储在pCSP上的数据，并获取查询结果。假设US可能不完全可信，因为他可能会获取到查询结果之外的一些数据，或者与pCSP合谋泄露交互信息。

4. **中间服务器（PrC）**：每个US都拥有一个PrC，这是一个在DO和US之间的可信服务器，可以由一组US共享。他有限的存储和计算能力，但通信带宽较小，他可以执行一些低成本的操作，例如，他通过可信渠道接收US的查询请求，并向US返回量化代码和查询索引。

为了保护搜索的安全，引入了Paillier同态算法，它支持加法同态和概率非对称加密。可以利用这个属性来加密查找表，并在不解密的情况下得到加密的近似距离。此外，还引入了AES，用于预处理数据库和代码。总的来说，将数据库和查询量化为短的PQ代码，并使用AES加密原始数据和代码，以在框架中构建IVF列表。为了安全地搜索，pCSP持有DO的加密数据库和加密的IVF列表；US从他的PrC提交加密的查询索引给pCSP；pCSP与US一起响应查询。下一个小节将详细描述完整的解决方案。

### 方案
全同态加密虽然是一种很好的加密方式，它可以使pCSP在密文形式下安全地进行搜索。然而，这种方法需要大量的密文计算和运行时间，尤其是在US必须处理大量的全同态解密操作时。这种计算负担对于移动终端等设备来说可能过于沉重。  
考虑到量化查询的特点。如果量化查询直接使用Paillier加密，那么每个查询需要进行大量的同态加密和同态加法。这对于移动终端用户来说，时间成本可能过高。因此，SCPQ选择不在US中直接执行Paillier加密，而是将码本转移到可信的PrC进行安全和快速的量化。整个方案需要保护搜索过程的安全。DO使用秘密密钥K加密数据库和倒排文件列表，并使用公钥pk加密查找表。US在加密查找表的成对密文上执行多次同态加法。然后，pCSP解密与加密数据对应的相关距离。这样，通过使用AES和Paillier算法，可以保护存储在pCSP和US上的数据。最后，为了减少通信成本，研究者引入了粗量化来构造粗码本和粗量化器，并使用k-means算法。他们设计了IVF列表以避免穷举搜索，这样US只需要访问与查询索引对应的IVF的内容。   
在整个查询过程中，US只需要进行简单的同态加法，因为大的同态解密负担被转移到了pCSP。这样，SCPQ解决方案在响应时间上应该更有效、更实用，特别是对于实际应用来说。

在这个过程中，粗码本和粗量化起也是一个重要的环节。这两个元素的设计目的是对数据集进行有效的划分和索引，以便在查询处理中快速并准确地找到候选结果。粗码本是一个包含了数据集中所有可能的粗量化值的列表。它的构建通常基于k-means聚类算法。在这个过程中，数据集被划分为$K_c$个簇，每个簇的中心（即聚类中心）代表了一个粗量化值。这些聚类中心构成了粗码本。

粗量化器$Q_c$的作用是将数据点映射到粗码本中的一个条目。具体来说，对于任意给定的数据点$x$，粗量化器会找到粗码本中最接近$x$的条目，并将其作为$x$的粗量化值。这种映射过程可以通过计算$x$与粗码本中每个条目的距离，并选择距离最小的那个条目来实现。

在这个设计中，粗码本和粗量化器共同作用，将数据集划分成多个簇，每个簇都由一个粗量化值（即聚类中心）代表。这种划分和索引方式可以大大提高搜索效率，因为在处理查询时，只需要在与查询索引对应的簇（即IVF列表的条目）中搜索，而不需要对整个数据集进行穷举搜索。

然而，这种方法也有一个缺点，那就是可能会导致搜索结果的质量下降。因为在处理查询时，真实的结果可能会出现在查询索引以外的簇中。为了解决这个问题作者提出了一个解决方案，即在处理每个查询时，选择$w$个最近的簇，并在这些簇的IVF列表条目中进行搜索。这样，可以获取到更多的候选结果，从而提高搜索质量。